<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Intent Surface v1.12 — /action/buy & /live.json</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{ color-scheme: dark }
  html,body{height:100%}
  body{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0d12;color:#e6edf3;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{font-size:18px;margin:0 0 10px}
  .note{opacity:.85;margin:6px 0 14px}
  .card{border:1px solid #293246;background:#0f131a;border-radius:10px;padding:12px;margin-bottom:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:10px}
  label{display:block;font-size:12px;opacity:.9;margin-bottom:4px}
  input,select{width:100%;padding:9px;border-radius:8px;background:#0b0f16;border:1px solid #293246;color:#e6edf3}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#1b2333;border:1px solid #2b3752;color:#e6edf3;padding:9px 12px;border-radius:8px;cursor:pointer}
  .btn:hover{background:#22304a}.btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #2b3752;border-radius:999px;margin-left:8px}
  #logs{height:220px;overflow:auto;white-space:pre-wrap}
  .ok{color:#8de18d}.warn{color:#ffda6b}.err{color:#ff8e8e}
  .hide{display:none}
  a{color:#8ab4ff}
</style>
</head>
<body>
<div class="wrap">
  <h1>Intent Surface — /action/buy & /live.json</h1>
  <div class="note">Open this page as <code>/action/buy?...</code> for one-click “Build &amp; Sign”. Otherwise you get a link-builder for testing.</div>

  <!-- BUILDER -->
  <div id="builder" class="card">
    <div class="grid">
      <div><label>Venue</label>
        <select id="venue"><option value="amm" selected>amm (Jupiter/Raydium)</option></select>
      </div>
      <div><label>In Mint (base58)</label>
        <input id="inMint" value="So11111111111111111111111111111111111111112">
      </div>
      <div><label>Out Mint (base58)</label>
        <input id="outMint" placeholder="Target token mint">
      </div>
      <div><label>Amount (in minor units)</label>
        <input id="amount" placeholder="10000000 for 0.01 SOL">
      </div>
      <div><label>Slippage (bps)</label>
        <input id="slippageBps" value="800">
      </div>
      <div><label>Referrer (pubkey; optional)</label>
        <input id="ref" placeholder="your referral pubkey">
      </div>
      <div><label>Platform Fee (bps; Jupiter)</label>
        <input id="platformFeeBps" placeholder="e.g. 5">
      </div>
      <div><label>RPC (getLatestBlockhash fallback)</label>
        <input id="rpc" placeholder="https://mainnet.helius-rpc.com/?api-key=...">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnMake">Make /action/buy link</button>
      <button class="btn" id="btnOpen">Open link</button>
      <button class="btn" id="btnCopy">Copy link</button>
      <button class="btn" id="btnLoadLive">Load from /live.json</button>
      <button class="btn" id="btnFollow">Follow /live.json</button>
      <span class="note">Links include <code>&auto=1</code> for auto-build on load.</span>
    </div>
  </div>

  <!-- ACTION -->
  <div id="action" class="card hide">
    <div class="row">
      <div>Wallet: <span id="wAddr" class="pill">disconnected</span></div>
      <div>Mode: <span class="pill">/action/buy</span></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnConnect">Connect Phantom</button>
      <button class="btn" id="btnBuild">Build</button>
      <button class="btn hide" id="btnCurve">Open on pump.fun (no AMM yet)</button>
    </div>
  </div>

  <div class="card">
    <div><b>Logs</b></div>
    <pre id="logs"></pre>
  </div>
</div>

<!-- web3 + buffer -->
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const params=new URLSearchParams(location.search);
  const isAction = location.pathname.replace(/\/+$/,'').endsWith('/action/buy') || params.get('action')==='buy';
  const LIVE_SRC = params.get('liveSrc') || 'https://harmonietrindal.github.io/solanagames/live.json';

  const log=(m,c='')=>{ const ts=new Date().toISOString().split('T')[1].replace('Z',''); const L=$('logs'); const d=document.createElement('div'); d.textContent=`${ts} ${m}`; if(c) d.classList.add(c); L.appendChild(d); L.scrollTop=L.scrollHeight; };
  const val=id=>$(id).value.trim(); const setV=(id,v)=>{ if(v!=null) $(id).value=v };
  const phantom=()=> (window.solana?.isPhantom ? window.solana : (window.phantom?.solana?.isPhantom ? window.phantom.solana : null));

  async function connectPhantom(onlyIfTrusted=false){
    const s=phantom(); if(!s) throw new Error('Phantom not found');
    try{ const r=await s.connect({onlyIfTrusted}); $('wAddr').textContent=r.publicKey.toString().slice(0,4)+'…'+r.publicKey.toString().slice(-4); $('wAddr').className='pill ok'; return r.publicKey.toString(); }
    catch(_){ log('Connect cancelled','warn'); return null; }
  }

  async function fetchLive(src=LIVE_SRC){
    try{
      const r=await fetch(src,{cache:'no-store',mode:'cors'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){
      try{
        const r=await fetch('https://r.jina.ai/http/'+src.replace(/^https?:\/\//,''));
        const txt=await r.text();
        return JSON.parse(txt);
      }catch(_){ throw e; }
    }
  }

  function hydrateFromParams(){
    setV('venue', params.get('venue'));
    setV('inMint', params.get('inMint'));
    setV('outMint', params.get('outMint'));
    setV('amount', params.get('amount'));
    setV('slippageBps', params.get('slippageBps'));
    setV('ref', params.get('ref'));
    setV('platformFeeBps', params.get('platformFeeBps'));
    setV('rpc', params.get('rpc'));
  }

  function makeLink(auto=true){
    const inMint  = val('inMint') || 'So11111111111111111111111111111111111111112';
    const outMint = val('outMint');
    const amount  = val('amount') || '10000000';
    const slip    = val('slippageBps') || '800';

    const base = location.origin + location.pathname.replace(/\/+$/,'').replace(/\/index\.html?$/,'');
    const qp = new URLSearchParams({
      venue: val('venue')||'amm',
      inMint, outMint, amount, slippageBps: slip,
      ref: val('ref'), platformFeeBps: val('platformFeeBps'),
      rpc: val('rpc'),
      auto: auto ? '1' : ''
    });
    [...qp.keys()].forEach(k=>{ if(qp.get(k)==='') qp.delete(k); });
    return `${base}/action/buy?${qp.toString()}`;
  }

  async function probePumpfun(mint) {
    try {
      const url = 'https://r.jina.ai/http/pump.fun/coin/' + mint;
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) return { ok:false, reason: 'http '+r.status };
      const txt = (await r.text()).toLowerCase();
      if (/token not found|null/i.test(txt)) return { ok:false, reason:'not_found' };
      if (/something went wrong|try again/i.test(txt)) return { ok:false, reason:'server_error' };
      if (/bonding curve|pump portal|holders|trades|comments|chat/i.test(txt)) return { ok:true };
      return { ok:false, reason:'inconclusive' };
    } catch { return { ok:false, reason:'fetch_fail' }; }
  }

  async function jupiterBuildAndSign(){
    const inMint  = params.get('inMint')  || val('inMint');
    const outMint = params.get('outMint') || val('outMint');
    const amount  = params.get('amount')  || val('amount');
    const slip    = Number(params.get('slippageBps') || val('slippageBps') || '800');

    const missing=[];
    if(!inMint)  missing.push('inMint');
    if(!outMint) missing.push('outMint');
    if(!amount)  missing.push('amount');
    if(missing.length){ log('Missing '+missing.join('/'), 'err'); throw new Error('Missing inMint/outMint/amount'); }

    const s=phantom(); if(!s) throw new Error('Phantom not found');
    if(!s.publicKey) await connectPhantom(true);
    if(!s.publicKey) throw new Error('Connect Phantom first');

    const qURL = new URL('https://quote-api.jup.ag/v6/quote');
    qURL.search = new URLSearchParams({
      inputMint: inMint,
      outputMint: outMint,
      amount,
      slippageBps: slip,
      onlyDirectRoutes: 'false',
      asLegacy: (params.get('asLegacy')==='1') ? 'true' : 'false'
    }).toString();

    const qRes = await fetch(qURL.toString(), { cache:'no-store' });
    const qTxt = await qRes.text();
    if(!qRes.ok){
      let code = '';
      try { code = (JSON.parse(qTxt).errorCode || '').toUpperCase(); } catch {}
      throw new Error(`JUP_${code || qRes.status}: ${qTxt.slice(0,200)}`);
    }
    let qJson;
    try { qJson = JSON.parse(qTxt); } catch { throw new Error('Quote JSON parse failed'); }
    if(!qJson?.data?.length){ throw new Error('No routes from Jupiter'); }

    const sRes = await fetch('https://quote-api.jup.ag/v6/swap', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({
        quoteResponse: qJson.data[0],
        userPublicKey: s.publicKey.toString(),
        wrapAndUnwrapSol: true,
        dynamicComputeUnitLimit: true,
        asLegacy: (params.get('asLegacy')==='1')
      })
    });
    if(!sRes.ok){ const txt=await sRes.text().catch(()=>String(sRes.status)); throw new Error(`Swap build failed: ${sRes.status} ${txt.slice(0,200)}`); }
    const sJson=await sRes.json();
    if(!sJson.swapTransaction) throw new Error('No swap transaction returned');

    const tx = solanaWeb3.VersionedTransaction.deserialize(Buffer.from(sJson.swapTransaction,'base64'));
    try{ const sig=await s.signAndSendTransaction(tx); log('Sent: '+(sig?.signature||JSON.stringify(sig)),'ok'); }
    catch(_){ log('User cancelled (no spend).','warn'); }
  }

  // Buttons
  $('btnMake').onclick = ()=> { const url=makeLink(true); log(url,'ok'); };
  $('btnOpen').onclick = ()=> window.open(makeLink(true),'_blank','noopener,noreferrer');
  $('btnCopy').onclick = async ()=> { await navigator.clipboard.writeText(makeLink(true)); log('Copied link','ok'); };

  $('btnLoadLive').onclick = async ()=>{
    try{
      const j=await fetchLive(); log('Loaded live.json','ok');
      const i=j.intent||{};
      setV('inMint', j.inMint || i.inMint || (i.mint? 'So11111111111111111111111111111111111111112' : val('inMint')));
      setV('outMint', j.outMint || i.mint || '');
      setV('amount', String(j.amount ?? '10000000'));
      setV('slippageBps', String(j.slippageBps ?? i.slippage_bps ?? '800'));
      const q = new URLSearchParams((new URL(j.action_url||'http://x/?')).search);
      setV('rpc', q.get('rpc')||val('rpc')); setV('ref', q.get('ref')||val('ref')); setV('platformFeeBps', q.get('platformFeeBps')||val('platformFeeBps'));
      log('Fields hydrated from live.json','ok');
    }catch(e){ log('Load live.json failed: '+(e.message||e),'err'); }
  };

  let followTimer=null, lastLiveTs=0, lastAction='';
  $('btnFollow').onclick = async ()=>{
    if(followTimer){ clearInterval(followTimer); followTimer=null; log('Stopped following live.json','warn'); return; }
    log('Following live.json…','ok');
    followTimer=setInterval(async()=>{
      try{
        const j=await fetchLive();
        const ts=Number(j.ts||j.intent?.ts||0);
        if(ts && ts!==lastLiveTs && j.action_url && j.action_url!==lastAction){
          lastLiveTs=ts; lastAction=j.action_url;
          log('Opening action: '+j.action_url,'ok'); window.open(j.action_url,'_blank','noopener,noreferrer');
        }
      }catch(_){}
    }, 1200);
  };

  $('btnConnect').onclick = ()=> connectPhantom(false);
  $('btnBuild').onclick   = async ()=>{
    try{
      $('btnCurve').classList.add('hide');
      await jupiterBuildAndSign();
    }catch(e){
      const msg = String(e);
      log('Build error: ' + msg, 'err');

      const nonRoutable =
        /No routes/i.test(msg) ||
        /not tradable/i.test(msg) ||
        /JUP_(TOKEN_NOT_TRADABLE|TOKEN_NOT_LISTED|TOKEN_NOT_SUPPORTED|400)/i.test(msg);

      if (nonRoutable) {
        $('btnCurve').classList.remove('hide');
        const outMint = params.get('outMint') || val('outMint');
        if (outMint) {
          const probe = await probePumpfun(outMint);
          if (probe.ok) {
            if (params.get('auto') === '1') {
              log('Auto-opening pump.fun (token not tradable yet).','warn');
              window.open(`https://pump.fun/coin/${outMint}`, '_blank', 'noopener,noreferrer');
            }
          } else {
            log(`Pump.fun page not healthy (${probe.reason}); not auto-opening.`, 'warn');
            const explorer = `https://explorer.solana.com/address/${outMint}`;
            const dexs     = `https://www.dexscreener.com/solana/${outMint}`;
            log(`Inspect: ${explorer}`, 'ok');
            log(`Dexscreener: ${dexs}`, 'ok');
          }
        }
        return;
      }

      if (/Missing inMint\/outMint\/amount/i.test(msg)) {
        try{
          const j=await fetchLive();
          if(j?.action_url){ log('Redirecting to live action_url','ok'); location.href=j.action_url; }
        }catch(_){}
      }
    }
  };
  $('btnCurve').onclick = ()=>{
    const mint = params.get('outMint') || val('outMint');
    if(mint) window.open(`https://pump.fun/coin/${mint}`,'_blank','noopener,noreferrer');
  };

  function toBuilder(){ $('builder').classList.remove('hide'); $('action').classList.add('hide'); }
  function toAction(){  $('builder').classList.add('hide'); $('action').classList.remove('hide'); }

  if(isAction){
    toAction();
    hydrateFromParams();
    log('Action mode');
    phantom() && phantom().connect({onlyIfTrusted:true}).catch(()=>{});
    const missing = !params.get('inMint') || !params.get('outMint') || !params.get('amount');
    if(missing){
      log('Params missing → fetching live.json…','warn');
      fetchLive().then(j=>{
        if(j?.action_url){ log('Redirecting to live action_url','ok'); location.href=j.action_url; }
      }).catch(e=>log('live.json fetch failed: '+(e.message||e),'err'));
    } else if(params.get('auto')==='1'){
      setTimeout(()=> $('btnBuild').click(), 350);
    }
  }else{
    toBuilder();
    log('Builder mode');
  }
})();
</script>
</body>
</html>
